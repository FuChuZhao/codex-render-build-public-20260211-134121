name: render-baseline-matrix

on:
  workflow_dispatch:
    inputs:
      source_repo_ssh:
        description: "SSH URL to private source repo"
        required: true
      source_ref:
        description: "source repo ref"
        required: true
        default: "main"
      codex_ref:
        description: "openai/codex ref/tag"
        required: true
        default: "rust-v0.98.0"
      scenario:
        description: "scenario name"
        required: true
        default: "cjk_wide_burst"
      artifact_name:
        description: "artifact base name"
        required: true
        default: "baseline"

permissions:
  contents: read

jobs:
  ubuntu_bash:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: dtolnay/rust-toolchain@stable
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}
      - name: Clone source
        shell: bash
        run: |
          GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=accept-new' git clone "${{ inputs.source_repo_ssh }}" source
          cd source
          git checkout "${{ inputs.source_ref }}"
      - name: Run validation
        shell: bash
        run: |
          cd source
          ./tool/ci/run-cloud-validation.sh --codex-ref "${{ inputs.codex_ref }}" --scenario "${{ inputs.scenario }}" --artifact-dir "$PWD/artifacts" --conservative-render false
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-ubuntu-bash
          path: source/artifacts
          retention-days: 1

  ubuntu_pwsh:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: dtolnay/rust-toolchain@stable
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}
      - name: Clone source
        shell: bash
        run: |
          GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=accept-new' git clone "${{ inputs.source_repo_ssh }}" source
          cd source
          git checkout "${{ inputs.source_ref }}"
      - name: Run validation
        shell: pwsh
        run: |
          cd source
          bash ./tool/ci/run-cloud-validation.sh --codex-ref "${{ inputs.codex_ref }}" --scenario "${{ inputs.scenario }}" --artifact-dir "$PWD/artifacts" --conservative-render false
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-ubuntu-pwsh
          path: source/artifacts
          retention-days: 1

  macos_bash:
    runs-on: macos-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: dtolnay/rust-toolchain@stable
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}
      - name: Clone source
        shell: bash
        run: |
          GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=accept-new' git clone "${{ inputs.source_repo_ssh }}" source
          cd source
          git checkout "${{ inputs.source_ref }}"
      - name: Run validation
        shell: bash
        run: |
          cd source
          ./tool/ci/run-cloud-validation.sh --codex-ref "${{ inputs.codex_ref }}" --scenario "${{ inputs.scenario }}" --artifact-dir "$PWD/artifacts" --conservative-render false
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-macos-bash
          path: source/artifacts
          retention-days: 1

  windows_pwsh:
    runs-on: windows-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: dtolnay/rust-toolchain@stable
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}
      - name: Clone source
        shell: pwsh
        run: |
          $env:GIT_SSH_COMMAND = "ssh -o StrictHostKeyChecking=accept-new"
          git clone "${{ inputs.source_repo_ssh }}" source
          cd source
          git checkout "${{ inputs.source_ref }}"
      - name: Run validation
        shell: pwsh
        run: |
          cd source
          ./tool/ci/run-cloud-validation.ps1 -CodexRef "${{ inputs.codex_ref }}" -Scenario "${{ inputs.scenario }}" -ArtifactDir "artifacts" -ConservativeRender:$false
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-windows-pwsh
          path: source/artifacts
          retention-days: 1

  windows_cmd:
    runs-on: windows-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: dtolnay/rust-toolchain@stable
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}
      - name: Clone source
        shell: pwsh
        run: |
          $env:GIT_SSH_COMMAND = "ssh -o StrictHostKeyChecking=accept-new"
          git clone "${{ inputs.source_repo_ssh }}" source
          cd source
          git checkout "${{ inputs.source_ref }}"
      - name: Run validation
        shell: cmd
        run: |
          cd source
          pwsh -File .\tool\ci\run-cloud-validation.ps1 -CodexRef "${{ inputs.codex_ref }}" -Scenario "${{ inputs.scenario }}" -ArtifactDir artifacts -ConservativeRender:$false
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-windows-cmd
          path: source/artifacts
          retention-days: 1
