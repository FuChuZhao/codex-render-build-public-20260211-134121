name: env-probe-matrix

on:
  workflow_dispatch:
    inputs:
      source_repo_ssh:
        description: "SSH URL to private source repo"
        required: true
      source_ref:
        description: "source repo ref"
        required: true
        default: "main"
      artifact_name:
        description: "artifact base name"
        required: true
        default: "env-probe"

permissions:
  contents: read

jobs:
  ubuntu_bash:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: dtolnay/rust-toolchain@stable
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}
      - name: Prepare known_hosts
        shell: bash
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
      - name: Clone source
        shell: bash
        run: |
          git clone "${{ inputs.source_repo_ssh }}" source
          cd source
          git checkout "${{ inputs.source_ref }}"
      - name: Probe terminals
        shell: bash
        run: |
          cd source
          ./tool/ci/install-terminals.sh "$PWD/artifacts"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-ubuntu-bash
          path: source/artifacts
          retention-days: 1

  ubuntu_pwsh:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: dtolnay/rust-toolchain@stable
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}
      - name: Prepare known_hosts
        shell: bash
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
      - name: Clone source
        shell: bash
        run: |
          git clone "${{ inputs.source_repo_ssh }}" source
          cd source
          git checkout "${{ inputs.source_ref }}"
      - name: Probe terminals
        shell: pwsh
        run: |
          cd source
          bash ./tool/ci/install-terminals.sh "$PWD/artifacts"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-ubuntu-pwsh
          path: source/artifacts
          retention-days: 1

  macos_bash:
    runs-on: macos-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: dtolnay/rust-toolchain@stable
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}
      - name: Prepare known_hosts
        shell: bash
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
      - name: Clone source
        shell: bash
        run: |
          git clone "${{ inputs.source_repo_ssh }}" source
          cd source
          git checkout "${{ inputs.source_ref }}"
      - name: Probe terminals
        shell: bash
        run: |
          cd source
          ./tool/ci/install-terminals.sh "$PWD/artifacts"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-macos-bash
          path: source/artifacts
          retention-days: 1

  windows_pwsh:
    runs-on: windows-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: dtolnay/rust-toolchain@stable
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}
      - name: Prepare known_hosts
        shell: pwsh
        run: |
          $sshDir = Join-Path $HOME ".ssh"
          New-Item -ItemType Directory -Path $sshDir -Force | Out-Null
          ssh-keyscan github.com | Out-File -FilePath (Join-Path $sshDir "known_hosts") -Append -Encoding ascii
      - name: Clone source
        shell: pwsh
        run: |
          git clone "${{ inputs.source_repo_ssh }}" source
          cd source
          git checkout "${{ inputs.source_ref }}"
      - name: Probe terminals
        shell: pwsh
        run: |
          cd source
          ./tool/ci/install-terminals.ps1 -ArtifactDir "artifacts"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-windows-pwsh
          path: source/artifacts
          retention-days: 1

  windows_cmd:
    runs-on: windows-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: dtolnay/rust-toolchain@stable
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}
      - name: Prepare known_hosts
        shell: pwsh
        run: |
          $sshDir = Join-Path $HOME ".ssh"
          New-Item -ItemType Directory -Path $sshDir -Force | Out-Null
          ssh-keyscan github.com | Out-File -FilePath (Join-Path $sshDir "known_hosts") -Append -Encoding ascii
      - name: Clone source
        shell: pwsh
        run: |
          git clone "${{ inputs.source_repo_ssh }}" source
          cd source
          git checkout "${{ inputs.source_ref }}"
      - name: Probe terminals
        shell: cmd
        run: |
          cd source
          pwsh -File .\tool\ci\install-terminals.ps1 -ArtifactDir artifacts
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-windows-cmd
          path: source/artifacts
          retention-days: 1
